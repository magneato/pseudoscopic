# Pseudoscopic CI/CD Workflow
#
# Builds and tests:
#   - Kernel driver (with matching compiler)
#   - Near-memory C library
#   - C++ wrapper (C++17/20)
#   - All examples
#
# Copyright (C) 2026 Neural Splines LLC

name: Pseudoscopic CI

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  #
  # Build Matrix: Multiple GCC versions and kernel configurations
  #
  build:
    name: Build (GCC ${{ matrix.gcc }}, ${{ matrix.build_type }})
    runs-on: ubuntu-${{ matrix.ubuntu }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu 22.04 with various GCC versions
          - ubuntu: "22.04"
            gcc: 11
            cxx_std: 17
            build_type: release
          - ubuntu: "22.04"
            gcc: 12
            cxx_std: 20
            build_type: release
          # Ubuntu 24.04 (latest)
          - ubuntu: "24.04"
            gcc: 13
            cxx_std: 20
            build_type: release
          # Debug build
          - ubuntu: "22.04"
            gcc: 11
            cxx_std: 17
            build_type: debug
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-${{ matrix.gcc }} \
            g++-${{ matrix.gcc }} \
            linux-headers-$(uname -r) || true
            
      - name: Configure Compiler
        run: |
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${{ matrix.gcc }} 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-${{ matrix.gcc }} 100
          
          echo "=== Compiler Versions ==="
          gcc --version | head -1
          g++ --version | head -1
          
          echo "=== Kernel Compiler ==="
          cat /proc/version | grep -oP 'gcc[^)]+' || echo "Unknown"
          
      - name: Check Kernel Compiler Match
        run: |
          KERNEL_GCC=$(cat /proc/version | grep -oP 'gcc[- ]version \K[0-9]+' | head -1 || echo "0")
          SYSTEM_GCC=${{ matrix.gcc }}
          
          echo "Kernel compiled with GCC major version: $KERNEL_GCC"
          echo "Building with GCC major version: $SYSTEM_GCC"
          
          if [ "$KERNEL_GCC" != "$SYSTEM_GCC" ]; then
            echo "::warning::Compiler version mismatch - driver may not load on this kernel"
          fi
          
      - name: Build Near-Memory Library
        working-directory: contrib/nearmem
        run: |
          make clean || true
          
          if [ "${{ matrix.build_type }}" = "debug" ]; then
            make lib CFLAGS="-Wall -Wextra -g -O0 -DDEBUG"
          else
            make lib CFLAGS="-Wall -Wextra -O2"
          fi
          
          echo "=== Library Built ==="
          ls -la libnearmem.*
          
      - name: Verify Library Symbols
        working-directory: contrib/nearmem
        run: |
          echo "=== Static Library Contents ==="
          ar -t libnearmem.a
          
          echo "=== Key Symbols ==="
          nm libnearmem.a | grep -E "^[0-9a-f]+ T" | head -20
          
      - name: Build Examples
        working-directory: contrib/nearmem
        run: |
          make examples
          
          echo "=== Examples Built ==="
          for ex in log_analyzer kv_cache_tier tiled_convolution tiled_matmul tiletrace gpucpu_demo gpufpga_demo abyssal_demo; do
            if [ -f "$ex" ]; then
              echo "✓ $ex ($(stat -c%s $ex) bytes)"
            fi
          done
          
      - name: Test C++ Wrapper Compilation
        working-directory: contrib/nearmem
        run: |
          cat > /tmp/test_wrapper.cpp << 'CPPEOF'
          #include "nearmem.hpp"
          #include <iostream>
          
          int main() {
              // Verify C++17 features work
              std::cout << "Testing C++ wrapper..." << std::endl;
              
              // Test Usage flags
              auto usage = nearmem::Usage::STREAMING | nearmem::Usage::GPU_ONLY;
              if (nearmem::has_flag(usage, nearmem::Usage::STREAMING)) {
                  std::cout << "  Usage flags: OK" << std::endl;
              }
              
              // Test GPU enumeration (will return 0 in CI)
              int count = nearmem::gpu_count();
              std::cout << "  GPU count: " << count << std::endl;
              
              // Test GPUInfo struct
              auto gpus = nearmem::enumerate_gpus();
              std::cout << "  Enumerated GPUs: " << gpus.size() << std::endl;
              
              std::cout << "C++ wrapper test passed!" << std::endl;
              return 0;
          }
          CPPEOF
          
          g++ -std=c++${{ matrix.cxx_std }} -Wall -Wextra -I./include \
              /tmp/test_wrapper.cpp -o /tmp/test_wrapper \
              -L. -lnearmem -lpthread -ldl
              
          # Run the test
          /tmp/test_wrapper
          
      - name: Build Kernel Module
        if: matrix.build_type == 'release'
        run: |
          echo "=== Building Kernel Module ==="
          make clean
          make module KDIR=/lib/modules/$(uname -r)/build
          
          if [ -f "pseudoscopic.ko" ]; then
            echo "✓ pseudoscopic.ko built successfully"
            modinfo pseudoscopic.ko | head -5
          else
            echo "::error::Module build failed"
            exit 1
          fi
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-gcc${{ matrix.gcc }}-${{ matrix.build_type }}
          path: |
            contrib/nearmem/libnearmem.a
            contrib/nearmem/libnearmem.so
            contrib/nearmem/include/*.h
            contrib/nearmem/include/*.hpp
          retention-days: 7

  #
  # Static Analysis
  #
  analyze:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install Analysis Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-tools
          
      - name: Run Cppcheck
        continue-on-error: true
        run: |
          cppcheck \
            --enable=warning,style,performance,portability \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            --std=c11 \
            -I contrib/nearmem/include \
            -I include \
            contrib/nearmem/src/ \
            2>&1 | tee analysis-cppcheck.txt
            
      - name: Analyze Results
        run: |
          echo "=== Analysis Summary ==="
          ERRORS=$(grep -c "error:" analysis-cppcheck.txt || echo "0")
          WARNINGS=$(grep -c "warning:" analysis-cppcheck.txt || echo "0")
          STYLE=$(grep -c "style:" analysis-cppcheck.txt || echo "0")
          
          echo "Errors: $ERRORS"
          echo "Warnings: $WARNINGS"
          echo "Style issues: $STYLE"
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Static analysis found $ERRORS errors"
          fi
          
      - name: Upload Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis
          path: analysis-*.txt
          retention-days: 30

  #
  # Documentation
  #
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Validate Documentation
        run: |
          echo "=== Checking Required Files ==="
          
          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "setup.sh"
            "contrib/nearmem/README.md"
            "contrib/nearmem/Makefile"
          )
          
          MISSING=0
          for f in "${REQUIRED_FILES[@]}"; do
            if [ -f "$f" ]; then
              echo "✓ $f"
            else
              echo "✗ $f (MISSING)"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo "::warning::$MISSING required files missing"
          fi
          
      - name: Check Header Documentation
        run: |
          echo "=== Header Files ==="
          for header in contrib/nearmem/include/*.h contrib/nearmem/include/*.hpp; do
            if [ -f "$header" ]; then
              LINES=$(wc -l < "$header")
              COMMENTS=$(grep -c '^\s*\*\|^\s*//' "$header" || echo "0")
              echo "$header: $LINES lines, $COMMENTS comment lines"
            fi
          done

  #
  # Release (on tag)
  #
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, analyze]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-gcc11-release
          path: artifacts/
          
      - name: Create Release Package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          
          mkdir -p release
          
          # Create source tarball
          tar --exclude='.git' \
              --exclude='*.o' \
              --exclude='*.ko' \
              -czvf release/pseudoscopic-$VERSION-src.tar.gz \
              .
              
          # Create binary tarball
          mkdir -p release/pseudoscopic-$VERSION-bin/{lib,include}
          cp artifacts/*.a artifacts/*.so release/pseudoscopic-$VERSION-bin/lib/
          cp -r artifacts/include/* release/pseudoscopic-$VERSION-bin/include/
          
          cd release
          tar -czvf pseudoscopic-$VERSION-bin.tar.gz pseudoscopic-$VERSION-bin/
          
          # Checksums
          sha256sum *.tar.gz > SHA256SUMS
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.tar.gz
            release/SHA256SUMS
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
